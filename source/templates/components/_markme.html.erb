<% markdown_parser = Redcarpet::Markdown.new(Redcarpet::Render::HTML) %>
<% fixed_markdown_text = markdown_text.to_s.strip %>
<% unless fixed_markdown_text.empty? %>
  <% fixed_markdown_text = fixed_markdown_text.gsub(/([^\n])(#)/, '\1 <br><br>\2') %>

  <% fixed_markdown_text = fixed_markdown_text.gsub('â€¢', "\n\n* ") %>
  <% fixed_markdown_text = fixed_markdown_text.gsub(/(\d+)\./, "<br>\n1. ") %>

  <% match = /## (.*?)\b/.match(fixed_markdown_text) %>
  <% if match && match[1] %>
    <% word = match[1] %>
    <% index = (1...word.length).find { |i| word[i].match?(/[A-Z]/) && word[i-1].match?(/\s/) && word[i+1].match?(/[a-z]/) } %>
    <% if index && index > 0 %>
      <% first_part = word[0...index] %>
      <% second_part = word[index..] %>
      <% fixed_markdown_text.sub!(word, "#{first_part}<br>\n#{second_part}") %>
    <% end %>
  <% end %>

  <%= markdown_parser.render(fixed_markdown_text).html_safe %>
<% end %>
